@page "/"
@page "/tasks"
@attribute [StreamRendering]
@rendermode InteractiveServer

<PageTitle>Tasks Overview</PageTitle>

<div class="row-fluid mb-2">
    <button class="btn btn-sm btn-createtask no-transition" @onclick="GotoCreate">Create Task</button>
    <button class="btn btn-sm btn-danger no-transition" @onclick="OpenClearTasksModal">Clear Tasks</button>
</div>
@if (_tasksStaged is null)
{
    <p><em>Loading...</em></p>
}
else if (_tasksStaged is not null)
{
    <div class="mt-4 mb-4">
        <h6 class="badge bg-dark m-0 w-100 text-start rounded-0 rounded-top">Staged</h6>
        <table class="table table-sm table-responsive">
            <thead>
                <tr>
                    <th>Id</th>
                    <th>Title</th>
                    <th>Description</th>
                    <th>Created</th>
                    <th>Status</th>
                    <th>Priority</th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                @foreach (var task in _tasksStaged!)
                {
                    <tr @key=task>
                        <td>@task.Id</td>
                        <td>@task.Title</td>
                        <td>@task.Description</td>
                        <td>@task.DateCreated</td>
                        <td>
                            <select @onchange="(e => StatusChanged(e, task))">
                            @foreach (Data.Enums.Status type in Enum.GetValues(typeof(Data.Enums.Status)))
                            {
                                if (task.Status == type)
                                {
                                    <option value="@type" selected>@type.GetDisplayName()</option>
                                }
                                else
                                {
                                    <option value="@type">@type.GetDisplayName()</option>
                                }
                            }
                            </select>
                        </td>
                        <td>@task.Priority</td>
                        <td>
                            <button class="btn btn-sm btn-secondary" @onclick="@(() => EditTask(task.Id))">Edit</button>
                            <button class="btn btn-sm btn-danger" @onclick="@(() => DeleteTask(task))">Delete</button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>        
    </div>
}
@if (_tasksInProgress is null)
{
    <p><em>Loading...</em></p>
}
else if (_tasksInProgress is not null)
{
    <div class="mt-4 mb-4">
        <h6 class="badge bg-dark m-0 w-100 text-start rounded-0 rounded-top">In Progress</h6>
        <table class="table table-sm table-responsive">
            <thead>
                <tr>
                    <th>Id</th>
                    <th>Title</th>
                    <th>Description</th>
                    <th>Created</th>
                    <th>Status</th>
                    <th>Priority</th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                @foreach (var task in _tasksInProgress!)
                {
                    <tr @key=task>
                        <td>@task.Id</td>
                        <td>@task.Title</td>
                        <td>@task.Description</td>
                        <td>@task.DateCreated</td>
                        <td>
                            <select @onchange="(e => StatusChanged(e, task))">
                            @foreach (Data.Enums.Status type in Enum.GetValues(typeof(Data.Enums.Status)))
                            {
                                if (task.Status == type)
                                {
                                    <option value="@type" selected>@type.GetDisplayName()</option>
                                }
                                else
                                {
                                    <option value="@type">@type.GetDisplayName()</option>
                                }
                            }
                            </select>
                        </td>
                        <td>@task.Priority</td>
                        <td>
                            <button class="btn btn-sm btn-secondary" @onclick="@(() => EditTask(task.Id))">Edit</button>
                            <button class="btn btn-sm btn-danger" @onclick="@(() => DeleteTask(task))">Delete</button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
}
@if (_tasksComplete is null)
{
    <p><em>Loading...</em></p>
}
else if (_tasksComplete is not null)
{
    <div class="mt-4">
        <h6 class="badge bg-dark m-0 w-100 text-start rounded-0 rounded-top">Complete</h6>
        <table class="table table-sm table-responsive">
            <thead>
                <tr>
                    <th>Id</th>
                    <th>Title</th>
                    <th>Description</th>
                    <th>Created</th>
                    <th>Status</th>
                    <th>Priority</th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                @foreach (var task in _tasksComplete!)
                {
                    <tr @key=task>
                        <td>@task.Id</td>
                        <td>@task.Title</td>
                        <td>@task.Description</td>
                        <td>@task.DateCreated</td>
                        <td>
                            <select @onchange="(e => StatusChanged(e, task))">
                            @foreach (Data.Enums.Status type in Enum.GetValues(typeof(Data.Enums.Status)))
                            {
                                if (task.Status == type)
                                {
                                    <option value="@type" selected>@type.GetDisplayName()</option>
                                }
                                else
                                {
                                    <option value="@type">@type.GetDisplayName()</option>
                                }
                            }
                            </select>
                        </td>
                        <td>@task.Priority</td>
                        <td>
                            <button class="btn btn-sm btn-secondary" @onclick="@(() => EditTask(task.Id))">Edit</button>
                            <button class="btn btn-sm btn-danger" @onclick="@(() => DeleteTask(task))">Delete</button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
}

@if (ClearTasksModalOpen)
{
    <Modal OnClose="ClearTasksModalOnClose" 
           Title="Clear Tasks"
           Body="Are you sure you want to clear tasks?"
           Buttons="Modal.ButtonType.DeleteCancel">
    </Modal>
}

@inject UpdateTitleService updateTitleService
@code {
    #pragma warning disable CS4014
    #pragma warning disable CS1998
    private DatabaseContext? _context;
    private Data.Models.Task[]? _tasksStaged;
    private Data.Models.Task[]? _tasksInProgress;
    private Data.Models.Task[]? _tasksComplete;
    private bool ClearTasksModalOpen { get; set; }

    private void ClearTasksModalOnClose(bool clearTasks)
    {
        if (clearTasks) this.ClearTasks();

        this.ClearTasksModalOpen = false;
        
        StateHasChanged();
    }

    private void OpenClearTasksModal()
    {
        this.ClearTasksModalOpen = true;

        StateHasChanged();
    }

    protected override async Task OnInitializedAsync()
    {
        await GetTasks();

        updateTitleService.UpdateTitle("Tasks Overview");
    }

    private void GotoCreate()
    {
        NavigationManager.NavigateTo("task");
    }

    private void ClearTasks()
    {
        _context ??= _contextFactory.CreateDbContext();

        _context.Database.ExecuteSqlRaw("DELETE FROM Tasks");
        _context.Database.ExecuteSqlRaw("DELETE FROM SQLITE_SEQUENCE WHERE name='Tasks'");

        GetTasks();
    }

    private void EditTask(int id)
    {
        NavigationManager.NavigateTo($"task/{id}");
    }

    private void DeleteTask(Data.Models.Task task)
    {
        task.Archived = true;

        _context?.Tasks.Update(task);
        _context?.SaveChanges();

        this.GetTasks();
    }

    private async Task GetTasks()
    {
        _context ??= _contextFactory.CreateDbContext();

        var tasks = _context.Tasks.ToArray();

        _tasksStaged = (from x in tasks
                        where x.Status == Data.Enums.Status.Staged && x.Archived == false
                        select x).ToArray();

        _tasksInProgress = (from x in tasks
                            where x.Status == Data.Enums.Status.InProgress && x.Archived == false
                            select x).ToArray();

        _tasksComplete = (from x in _context.Tasks
                          where x.Status == Data.Enums.Status.Complete && x.Archived == false
                          select x).ToArray();
    }

    private void StatusChanged(ChangeEventArgs e, Data.Models.Task task)
    {
        _context ??= _contextFactory.CreateDbContext();

        if (Enum.TryParse<Data.Enums.Status>(e.Value?.ToString(), out var status))
        {
            task.Status = status;
            _context.Tasks.Update(task);
            _context.SaveChanges();

            GetTasks();
        }
    }
}